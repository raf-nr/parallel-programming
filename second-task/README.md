# Code analysis tools

## Santa Claus Problem
В качестве стартового проекта была взята реализация задачи Санта-Клауса из [данного репозитория](https://github.com/mussaiin/Santa-Claus-Problem). Из двух предложенных вариантов была выбрана реализация с мьютексами и условными переменными.

Сама задача Санта-Клауса формулируется следующим образом: Проблема Санта-Клауса — это классическая задача синхронизации, используемая для изучения многопоточности и управления параллелизмом. В этой задаче задействованы несколько сущностей: Санта-Клаус, эльфы и северные олени. Задача демонстрирует, как координировать работу этих сущностей с использованием механизмов синхронизации, таких как семафоры и мьютексы.

### Условия задачи
- Санта-Клаус: спит в своем доме на Северном полюсе, но просыпается при определенных условиях:
  - Если в мастерской собирается трое эльфов с проблемами, которым нужна помощь.
  - Если 9 северных оленей вернулись с отпуска и готовы разносить подарки.


- Эльфы: работают в своей мастерской. Время от времени у них возникают проблемы, которые они не могут решить самостоятельно, и они собираются группами по трое, чтобы разбудить Санту для помощи.


- Северные олени: периодически уходят в отпуск и возвращаются. Когда все 9 оленей вернулись, они готовы тянуть сани и ждут, пока Санта раздаст подарки.
<details>
<summary>Реализация синхронизации</summary>

Для решения задачи используются примитивы синхронизации, такие как семафоры (реализованные, с помощью мьютексов и условных переменных) и мьютексы. Примерный алгоритм может быть таким:

- Мьютекс для синхронизации состояния Санты: для предотвращения одновременного обращения к Сантен для помощи эльфов и запряжки оленей.

- Семафоры для групп эльфов и оленей:

  - Эльфы: семафор для контроля числа эльфов, которые могут одновременно обращаться за помощью.
  - Олени: семафор для ожидания возвращения всех оленей с отпуска.
</details>

## Анализ кода

Изначальная реализация представлена [здесь](./santa-claus-problem).

Сначала код компилировался с флагом `-fsanitize=thread`. В результате санитайзер никаких ошибок [не выявил](./santa-claus-problem/results/threadsanitizer.txt).

Затем запускался `valgrind` с флагом `--tols=halgrind`. В результате работы `valgrid` никаких ошибок [не выявил](./santa-claus-problem/results/helgrind.jpg).

Таким образом, никаких ошибок в работе программы не выявлено.

## Создание искуственной гонки данных

Создать какую-то сильно "естественную" гонку, к сожалению, не получилось, поэтому были созданы более "искуственные гонки", но сразу три.

### Data race first
Реализация с гонкой данных представлена [здесь](./santa-claus-problem-data-race-first).

В данной реализации мы просто в функции Reindeer отпускаем мьютекс сразу после увелечения глобальной переменной. Однако следом у нас идет чтение этой глобальной переменной. Именно из-за этого могут возникать неожиданные сценарии.

`Thread sanitizer` успешно обнаружил описанную выше гонку данных. Результат [здесь](./santa-claus-problem-data-race-first/results/threadsanitizer.txt).

`Helgrind` также успешно обнаружил описанную выше гонку данных. Результат [здесь](./santa-claus-problem-data-race-first/results/helgrind.jpg).

### Data race second
Реализация с гонкой данных представлена [здесь](./santa-claus-problem-data-race-second).

В данной реализации мы заводим новую глобальную переменную, которую функции Санты, эльфов и оленей будут изменять. Однако они делают это обычным инкрементом, без какой-либо синхронизации потоков в данном месте. Тем самым может возникнуть гонка данных.

`Thread sanitizer` успешно обнаружил описанную выше гонку данных. Результат [здесь](./santa-claus-problem-data-race-second/results/threadsanitizer.txt).

`Helgrind` также успешно обнаружил описанную выше гонку данных. Результат [здесь](./santa-claus-problem-data-race-second/results/).

### Data race third
Реализация с гонкой данных представлена [здесь](./santa-claus-problem-data-race-third).

На этот раз мы меняем не саму реализацию программы, а реализацию семафоров, которые используются в этой программе. В функции `wait` меняем местами взятие и отпускание мьютекса. В результате программа будет работать неправильно, и в нужном месте у нас не будет блокировки, что приведет к гонке данных.

`Thread sanitizer` успешно обнаружил описанную выше гонку данных. Результат [здесь](./santa-claus-problem-data-race-third/results/threadsanitizer.txt).

`Helgrind` также успешно обнаружил описанную выше гонку данных. Результат [здесь](./santa-claus-problem-data-race-third/results/).

## Результат

В изначальной реализации не удалось найти ошибок. Однако во всех "искусственных" реализациях, где они ожидались, они были успешно обнаружены
